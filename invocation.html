<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invocation and Preamble - Covenant</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,500;0,600;0,700;1,400&family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=Cormorant+Garamond:ital,wght@0,400;0,500;0,600;0,700;1,400&display=block" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2c3e50;
            --accent-color: #8b7355;
            --text-color: #1a1a1a;
            --bg-color: #fafaf8;
            --sentence-highlight: #f0e3d4;
            --glyph-red: #8b2f2f;
            --glyph-gold: #c9a961;
            --footer-height: 70px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            height: 100%;
            font-family: 'Lora', serif;
            background-color: #000;
            font-size: 16px;
            scroll-behavior: smooth;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.7;
            margin: 0 auto;
            padding: 40px 20px 100px;
            min-height: 100vh;
            position: relative;
        }

        /* Loading Overlay */
        #loadingIcon {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            color: var(--accent-color);
            z-index: 10001;
            animation: rotateGlyph 2s linear infinite;
            pointer-events: none;
            opacity: 1;
            transition: opacity 0.5s ease-out;
        }

        #loadingIcon.fade-out {
            opacity: 0;
        }

        @keyframes rotateGlyph {
            from { transform: translate(-50%, -50%) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }

        #blackFadeOverlay {
            position: fixed;
            inset: 0;
            background-color: #000;
            z-index: 10000;
            pointer-events: none;
            transition: opacity 1.5s ease-out;
        }

        #blackFadeOverlay.fade-out {
            opacity: 0;
        }

        /* Main Content Container */
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: var(--bg-color);
            padding: 60px;
            border-radius: 2px;
            opacity: 0;
            transition: opacity 1s ease-in;
        }

        .container.fade-in {
            opacity: 1;
        }

        /* Section Header */
        .section-header {
            text-align: center;
            margin-bottom: 50px;
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 30px;
        }

        .ornament {
            font-size: 28px;
            letter-spacing: 12px;
            margin-bottom: 20px;
            color: var(--accent-color);
        }

        h1 {
            font-family: 'Crimson Text', serif;
            font-size: 2.5em;
            font-weight: 600;
            letter-spacing: 2px;
            margin: 20px 0;
            color: var(--primary-color);
            text-transform: uppercase;
        }

        /* Text Content */
        p {
            margin-bottom: 18px;
            text-align: justify;
            hyphens: none;
            text-wrap: balance;
        }

        p.preamble {
            font-style: italic;
            color: #555;
            font-size: 0.95em;
        }

        .section-divider {
            text-align: center;
            color: var(--glyph-gold);
            font-size: 0.9rem;
            margin: 1rem 0;
            user-select: none;
        }

        /* Glossary Terms & Tooltips */
        .glossary-term {
            cursor: help;
            border-bottom: 1px dotted var(--accent-color);
            position: relative;
            color: var(--primary-color);
            font-weight: 500;
            transition: background-color 0.2s ease;
        }

        .glossary-term:hover {
            background-color: rgba(139, 115, 85, 0.1);
        }

        .glossary-ref {
            vertical-align: super;
            font-size: 0.75em;
            margin-left: 2px;
            color: var(--accent-color);
            font-weight: bold;
        }

        .tooltip {
            visibility: hidden;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--primary-color);
            color: white;
            text-align: center;
            padding: 10px 15px;
            border-radius: 4px;
            font-size: 0.85em;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            font-style: normal;
            font-weight: 400;
            max-width: 280px;
            line-height: 1.4;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: none;
        }

        .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: var(--primary-color) transparent transparent transparent;
        }

        .glossary-term:hover .tooltip,
        .glossary-term.tooltip-active .tooltip {
            visibility: visible;
        }

        /* Sentence Selection */
        .sentence {
            cursor: pointer;
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
        }

        .sentence.is-selected {
            background-color: var(--sentence-highlight);
            box-shadow: 0 0 0 1px rgba(139, 115, 85, 0.25);
        }

        .sentence-label {
            font-size: 0.7em;
            vertical-align: super;
            color: #b79a76;
            margin-right: 0.2em;
            user-select: none;
            transition: color 0.2s ease;
        }

        .sentence.is-selected .sentence-label {
            color: var(--glyph-gold);
        }

        /* Sticky Footer Navigation */
        .nav-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: var(--footer-height);
            background: linear-gradient(to bottom, 
                #6a1f20 0%, 
                #5a1b1d 20%, 
                #4a171a 35%, 
                #3a1316 50%, 
                #2a0f12 65%, 
                #1a0b0e 80%, 
                #0a0a0a 100%);
            border-top: 1px solid #4a171a;
            border-bottom: 1px solid #0a0a0a;
            box-shadow: 0 -12px 20px -8px rgba(0, 0, 0, 0.8), 
                        inset 0 -8px 16px -10px rgba(0, 0, 0, 0.6);
            z-index: 1200;
            opacity: 0;
            transition: opacity 0.5s ease-in;
        }

        .nav-footer.fade-in {
            opacity: 1;
        }

        .nav-footer-inner {
            max-width: 900px;
            margin: 0 auto;
            height: 100%;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            align-items: center;
        }

        /* Navigation Buttons - Base Styles */
        .nav-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            border: none;
            background: transparent;
            font-size: 1.8rem;
            color: var(--glyph-gold);
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            -webkit-tap-highlight-color: transparent;
            position: relative;
        }

        .nav-btn:hover:not(:disabled),
        .nav-btn:focus-visible:not(:disabled) {
            color: #f5d98c;
            transform: scale(1.1);
        }

        .nav-btn:disabled {
            opacity: 0.25;
            cursor: not-allowed;
        }

        /* Arrow Buttons - Borders */
        .nav-btn:not(.center)::before {
            content: '';
            position: absolute;
            inset: 12px;
            border: 1px solid #571619;
            border-radius: 4px;
            box-shadow: inset 0 0 12px rgba(0, 0, 0, 0.95);
            transition: all 0.3s ease;
            pointer-events: none;
        }

        .nav-btn:not(.center):hover::before,
        .nav-btn:not(.center):focus-visible::before {
            border-color: #6a1f20;
            box-shadow: inset 0 0 14px rgba(0, 0, 0, 0.95);
        }

        .nav-btn:not(.center):disabled::before {
            border-color: rgba(87, 22, 25, 0.15);
            box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.7);
        }

        /* Arrow Buttons - Backgrounds */
        .nav-btn:not(.center)::after {
            content: '';
            position: absolute;
            inset: 12px;
            border-radius: 4px;
            z-index: -1;
            transition: all 0.3s ease;
            pointer-events: none;
        }

        .nav-btn:first-child::after {
            background-color: rgba(141, 130, 120, 0.15);
        }

        .nav-btn:first-child:hover::after,
        .nav-btn:first-child:focus-visible::after {
            background-color: rgba(141, 130, 120, 0.2);
        }

        .nav-btn:first-child:disabled::after {
            background-color: rgba(141, 130, 120, 0.08);
        }

        .nav-btn:last-child::after {
            background-color: #8D8278;
        }

        .nav-btn:last-child:hover::after,
        .nav-btn:last-child:focus-visible::after {
            background-color: #9d9288;
        }

        /* Lexicon Button - Center */
        .nav-btn.center {
            font-size: 2rem;
        }

        .nav-btn.center::before {
            content: '';
            position: absolute;
            inset: 10px;
            border: 1px solid #571619;
            border-radius: 4px;
            box-shadow: inset 0 0 12px rgba(0, 0, 0, 0.9);
            transition: all 0.3s ease;
            pointer-events: none;
        }

        .nav-btn.center:hover::before,
        .nav-btn.center:focus-visible::before {
            border-color: #6a1f20;
            box-shadow: inset 0 0 14px rgba(0, 0, 0, 0.95);
        }

        .nav-btn.center::after {
            content: '';
            position: absolute;
            inset: 10px;
            background-color: var(--glyph-red);
            border-radius: 4px;
            z-index: -1;
            transition: all 0.3s ease;
            pointer-events: none;
        }

        .nav-btn.center:hover::after,
        .nav-btn.center:focus-visible::after {
            background-color: #7a2929;
        }

        /* Lexicon Button - Active State */
        .nav-btn.center.has-selection {
            color: #f5d98c;
        }

        .nav-btn.center.has-selection::before {
            transform: translateY(-1px);
            box-shadow: inset 0 0 14px rgba(0, 0, 0, 0.95),
                        0 0 16px rgba(201, 169, 97, 0.6);
        }

        .nav-btn.center.has-selection::after {
            background-color: #6b1f1f;
            transform: translateY(-1px);
        }

        /* Lexicon Overlay */
        .lexicon-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.25s ease;
            z-index: 700;
        }

        .lexicon-overlay.is-open {
            opacity: 1;
            visibility: visible;
        }

        /* Lexicon Panel */
        .lexicon-panel {
            position: fixed;
            top: 0;
            right: 0;
            height: 100vh;
            width: min(360px, 90vw);
            background-color: #1a1a1a;
            border-left: 1px solid #3a3a3a;
            box-shadow: none;
            transform: translateX(100%);
            transition: transform 0.3s ease, box-shadow 0.3s ease, opacity 2.5s ease-in;
            z-index: 1100;
            display: flex;
            flex-direction: column;
            padding: 24px 20px;
            opacity: 0;
        }

        .lexicon-panel.fade-in {
            opacity: 1;
        }

        .lexicon-panel.is-open {
            transform: translateX(0);
            box-shadow: -2px 0 12px rgba(0, 0, 0, 0.5);
        }

        .lexicon-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .lexicon-panel-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.4rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--glyph-gold);
        }

        .lexicon-panel-mode {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: #b8986a;
            margin-top: 4px;
        }

        .lexicon-panel-close {
            border: none;
            background: transparent;
            font-size: 1.8rem;
            cursor: pointer;
            color: var(--glyph-gold);
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s ease;
        }

        .lexicon-panel-close:hover,
        .lexicon-panel-close:focus-visible {
            color: #e0bf7a;
        }

        .lexicon-panel-body {
            font-size: 0.95rem;
            color: #d4d4d4;
            line-height: 1.6;
            flex: 1 1 auto;
            overflow-y: auto;
            padding-right: 12px;
            scrollbar-width: thin;
            scrollbar-color: var(--glyph-gold) #555;
        }

        .lexicon-panel-body::-webkit-scrollbar {
            width: 10px;
        }

        .lexicon-panel-body::-webkit-scrollbar-track {
            background: #555;
        }

        .lexicon-panel-body::-webkit-scrollbar-thumb {
            background: var(--glyph-gold);
        }

        .lexicon-panel-body::-webkit-scrollbar-thumb:hover {
            background: #d4b070;
        }

        .lexicon-panel-body p {
            padding-right: 20px;
        }

        .lexicon-panel-body p + p {
            margin-top: 0.9rem;
        }

        .lexicon-sentence-quote {
            font-size: 0.88rem;
            font-style: italic;
            color: #a8a8a8;
            margin-bottom: 1rem;
            padding: 0.6rem 1rem;
            padding-right: 20px;
            background: #262626;
            border-left: 2px solid var(--glyph-gold);
            line-height: 1.5;
        }

        .lexicon-link {
            display: inline-block;
            margin-top: 1.2rem;
            padding: 0.5rem 1.2rem;
            border-radius: 2px;
            border: 1px solid var(--glyph-gold);
            color: var(--glyph-gold);
            text-decoration: none;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            font-size: 0.8rem;
            transition: background-color 0.2s ease, color 0.2s ease;
            background-color: #262626;
        }

        .lexicon-link:hover,
        .lexicon-link:focus-visible {
            background-color: var(--glyph-gold);
            color: #1a1a1a;
        }

        .lexicon-glossary-footer {
            margin-top: 1.6rem;
            padding-top: 1rem;
            border-top: 1px solid #3a3a3a;
            font-size: 0.85rem;
        }

        .lexicon-glossary-footer h3 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1rem;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            margin-bottom: 0.6rem;
            color: var(--glyph-gold);
        }

        .lexicon-term-list {
            list-style: none;
        }

        .lexicon-term-list li + li {
            margin-top: 0.5rem;
        }

        .lexicon-term-label {
            font-weight: 600;
            color: #e0bf7a;
        }

        .lexicon-term-ref {
            font-size: 0.75rem;
            vertical-align: super;
            color: var(--glyph-gold);
            margin-left: 2px;
        }

        /* Media Queries */
        @media print {
            #loadingIcon,
            #blackFadeOverlay,
            .nav-footer,
            .lexicon-panel,
            .lexicon-overlay {
                display: none !important;
            }

            html,
            body {
                background-color: white;
            }

            body {
                padding: 0;
            }

            .container {
                padding: 0;
                opacity: 1 !important;
            }

            .tooltip {
                display: none;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 20px 10px 90px;
                font-size: 15px;
            }

            .container {
                padding: 30px 20px;
            }

            h1 {
                font-size: 1.8em;
            }

            #loadingIcon {
                font-size: 36px;
            }

            .tooltip {
                max-width: 240px;
            }

            .nav-btn {
                padding: 16px;
                font-size: 1.5rem;
            }

            .nav-btn.center {
                font-size: 1.7rem;
            }
        }

        @media (max-width: 600px) {
            .lexicon-panel {
                top: auto;
                bottom: var(--footer-height);
                right: 0;
                left: 0;
                width: 100vw;
                height: 70vh;
                border-left: none;
                border-top: 1px solid #3a3a3a;
                border-radius: 12px 12px 0 0;
                transform: translateY(100%);
                z-index: 800;
            }

            .lexicon-panel.is-open {
                transform: translateY(0);
                box-shadow: 0 -2px 12px rgba(0, 0, 0, 0.5);
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 20px 15px;
            }

            h1 {
                font-size: 1.5em;
                letter-spacing: 1px;
            }

            .ornament {
                font-size: 20px;
                letter-spacing: 8px;
            }

            #loadingIcon {
                font-size: 32px;
            }

            .tooltip {
                max-width: 200px;
            }

            .nav-btn {
                padding: 14px;
                font-size: 1.3rem;
            }

            .nav-btn.center {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div id="loadingIcon">÷é</div>
    <div id="blackFadeOverlay"></div>

    <div class="container">
        <div class="section-header">
            <div class="ornament">‚ú¶ ‚úß ‚ú¶</div>
            <h1>Invocation and Preamble</h1>
            <div class="ornament">‚ú¶ ‚úß ‚ú¶</div>
        </div>

        <section id="invocation">
            <p class="preamble">
                <span class="sentence" data-lexicon-key="I.1" data-sentence-text="Let silence bear witness before the first word is spoken, that every word thereafter invoke the order of the stars‚Äîunder witness of the Earth.">
                    Let silence bear witness before the first word is spoken, that every word thereafter invoke the order of the&nbsp;stars‚Äîunder witness of&nbsp;the&nbsp;Earth.
                </span>
            </p>

            <p>
                <span class="sentence" data-lexicon-key="I.2" data-sentence-text="For hierarchy is no creation of man, but a mirror of the firmament: as command descends through the Lord, so obedience ascends through the Faithful.">
                    <span class="sentence-label">2</span>
                    For
                    <span class="glossary-term">hierarchy<span class="glossary-ref">[3]</span><span class="tooltip">The sacred ordering of authority and obedience.</span></span>
                    is no creation of man, but a mirror of the firmament: as
                    <span class="glossary-term">command<span class="glossary-ref">[4]</span><span class="tooltip">An authoritative directive given by the Lord.</span></span>
                    descends through the Lord, so
                    <span class="glossary-term">obedience<span class="glossary-ref">[5]</span><span class="tooltip">The willing submission and faithful execution of commands.</span></span>
                    ascends through&nbsp;the
                    <span class="glossary-term">Faithful<span class="glossary-ref">[1]</span><span class="tooltip">The devoted servant and obedient instrument within this sacred bond.</span></span>.
                </span>
            </p>

            <p>
                <span class="sentence" data-lexicon-key="I.3" data-sentence-text="Thereby all who swear falsely desecrate not only trust but the very sanctity of oath itself‚Äîthe sacred order upon which all rightful bonds depend.">
                    <span class="sentence-label">3</span>
                    Thereby all who swear falsely desecrate not only trust but the very sanctity of oath itself‚Äîthe sacred order upon which all rightful bonds&nbsp;depend.
                </span>
            </p>

            <p>
                <span class="sentence" data-lexicon-key="I.4" data-sentence-text="Let deceit remain unspoken, avarice cast into the void, and word and spirit be as one.">
                    <span class="sentence-label">4</span>
                    Let deceit remain unspoken, avarice cast into the void, and word and spirit be as&nbsp;one.
                </span>
                <span class="sentence" data-lexicon-key="I.5" data-sentence-text="Thus shall the Covenant endure, an everlasting reflection of divine allegiance.">
                    <span class="sentence-label">5</span>
                    Thus shall the
                    <span class="glossary-term">Covenant<span class="glossary-ref">[2]</span><span class="tooltip">A sacred, binding agreement between the Lord and the Faithful.</span></span>
                    endure, an everlasting reflection of divine&nbsp;allegiance.
                </span>
            </p>

            <div class="section-divider">‚ú¶ ‚úß ‚ú¶</div>
        </section>
    </div>

    <!-- Sticky Footer Navigation -->
    <nav class="nav-footer" id="navFooter" aria-label="Covenant navigation">
        <div class="nav-footer-inner">
            <button class="nav-btn" disabled aria-label="Previous section">Ôºú</button>
            <button class="nav-btn center" id="lexiconToggle" type="button" aria-label="Open Lexicon">ñ§ç</button>
            <a href="foundation.html" class="nav-btn" aria-label="Next: Foundation">Ôºû</a>
        </div>
    </nav>

    <div class="lexicon-overlay" id="lexiconOverlay" aria-hidden="true"></div>

    <div class="lexicon-panel" id="lexiconPanel" aria-hidden="true">
        <div class="lexicon-panel-header">
            <div>
                <div class="lexicon-panel-title">Lexicon</div>
                <div class="lexicon-panel-mode" id="lexiconModeLabel">Invocation and Preamble</div>
            </div>
            <button class="lexicon-panel-close" type="button" aria-label="Close Lexicon panel">√ó</button>
        </div>
        <div class="lexicon-panel-body">
            <div id="lexiconDynamicContent">
                <p>
                    This opening passage marks the ceremonial threshold where three authorities are called to witness‚Äîsilence (formless void), stars (celestial realm), Earth (material plane). The celestial order ("mirror of the firmament") is then reflected in the structure of the bond: Lord-Covenant-Faithful, where the Covenant is mediator between Lord and&nbsp;Faithful.
                </p>
                <div class="section-divider">‚ú¶</div>
                <p>
                    The preamble then unfolds in four movements‚Äîordination, admonition, purification, declaration‚Äîestablishing structure, condemning falsification, expelling corruption, and sealing the binding force. All that follows‚ÄîDoctrinal Foundation, Articles, Rituals, the Oath‚Äîflows out from this cosmic&nbsp;frame.
                </p>
            </div>

            <a href="lexicon.html" target="_blank" rel="noopener" class="lexicon-link">Open Full Lexicon</a>

            <div class="lexicon-glossary-footer" aria-label="Glossary terms on this page">
                <h3>Terms in this section</h3>
                <ul class="lexicon-term-list">
                    <li><span class="lexicon-term-label">Faithful</span><span class="lexicon-term-ref">[1]</span> ‚Äì The devoted servant and obedient instrument within this sacred bond.</li>
                    <li><span class="lexicon-term-label">Covenant</span><span class="lexicon-term-ref">[2]</span> ‚Äì A sacred, binding agreement between the Lord and the Faithful.</li>
                    <li><span class="lexicon-term-label">Hierarchy</span><span class="lexicon-term-ref">[3]</span> ‚Äì The sacred ordering of authority and obedience.</li>
                    <li><span class="lexicon-term-label">Command</span><span class="lexicon-term-ref">[4]</span> ‚Äì An authoritative directive given by the Lord.</li>
                    <li><span class="lexicon-term-label">Obedience</span><span class="lexicon-term-ref">[5]</span> ‚Äì The willing submission and faithful execution of commands.</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
    (function () {
        'use strict';
        
        var loadingIcon = document.getElementById('loadingIcon');
        var overlay = document.getElementById('blackFadeOverlay');
        var container = document.querySelector('.container');
        var navFooter = document.getElementById('navFooter');
        var panel = document.getElementById('lexiconPanel');
        var lexiconToggle = document.getElementById('lexiconToggle');
        var lexOverlay = document.getElementById('lexiconOverlay');
        var dynamicContent = document.getElementById('lexiconDynamicContent');
        var defaultOverviewHTML = dynamicContent ? dynamicContent.innerHTML : '';
        var currentlySelectedSentence = null;

        // Sentence explanations
        var sentenceExplanations = {
            'I.1': 'The Invocation solves a structural problem: how to establish hierarchy without reducing it to human claim. Three authorities are summoned in descending order‚Äîsilence (void above all), stars (celestial pattern), Earth (terrestrial witness)‚Äîembodying the vertical structure before naming it. This makes ordination, admonition, purification, and declaration possible: each operates within cosmic framework already enacted. Without this opening, the preamble begins with assertion requiring justification. With witness invoked, subsequent language becomes ritual recognition within pre-existing sacred order.',
            'I.2': 'This passage ordains the structure of the Covenant in reflection of the invocation. "Mirror of the firmament" refers to the celestial order in the opening passage‚Äîthe hierarchy as an existing architecture is directly called to witness before any declarations are made. The hierarchy is already sanctified: the void (Lord), the firmament (Covenant as mediator), the Earth (Faithful). No judge can assert what a witness has proclaimed, because it is already established as-it-is. This transforms the bond from temporal contract into holy sacrament within a pre-existing cosmic order.',
            'I.3': 'This passage of admonition outlines the toll of swearing falsely. "Thereby" creates logical chain: because the structure mirrors the firmament, fabricating oath is desecration of the cosmic plane itself. The passage escalates‚Äîbetrayal of bond, violation of oath, profanation of order. To swear falsely is to weaponize the fulcrum keeping everything intact. Because witness was invoked and the order sanctified, oath-breaking becomes spiritual transgression, not merely breach of contract.',
            'I.4': 'Purification responds to Admonition\'s warning by expelling corruption from the threshold. Three corruptions are cast out in sequence: deceit must remain unspoken (false speech banned from the sacred space), avarice must be cast into the void (greed expelled entirely), and word and spirit must become one (interior intention matched to exterior utterance). This is the positive counterpart to the warning‚Äîwhere Admonition says "false oaths desecrate," Purification says "therefore let corruption be expelled and truth unified." The passage ensures that what was invoked, ordained, and protected can now endure. Without purification, the bond rests on contaminated ground; with it, the threshold is sanctified for Declaration.',
            'I.5': 'This passage of declaration seals what the four prior movements have prepared. "Thus" binds the logic: witness invoked, order ordained, profanation warned, corruption expelled‚Äîtherefore the Covenant may endure by right, sustained within the order as established. In calling the Covenant "an everlasting reflection of divine allegiance," the bond is rendered sacred‚Äînot a mere arrangement, but something not to be extinguished.'
        };

        // Loading sequence
        setTimeout(function() {
            if (loadingIcon) loadingIcon.classList.add('fade-out');
            setTimeout(function() {
                overlay.classList.add('fade-out');
                setTimeout(function() {
                    container.classList.add('fade-in');
                    if (navFooter) navFooter.classList.add('fade-in');
                    if (panel) panel.classList.add('fade-in');
                    setTimeout(function() {
                        if (loadingIcon && loadingIcon.parentNode) loadingIcon.parentNode.removeChild(loadingIcon);
                        if (overlay && overlay.parentNode) overlay.parentNode.removeChild(overlay);
                    }, 1500);
                }, 1500);
            }, 500);
        }, 1800);

        // Lexicon button state
        function updateLexiconButtonState() {
            if (!lexiconToggle) return;
            lexiconToggle.classList.toggle('has-selection', !!currentlySelectedSentence);
        }

        // Panel controls
        function openPanel() {
            if (!panel || !lexOverlay) return;
            panel.classList.add('is-open');
            lexOverlay.classList.add('is-open');
            panel.setAttribute('aria-hidden', 'false');
            lexOverlay.setAttribute('aria-hidden', 'false');
        }

        function closePanel() {
            if (!panel || !lexOverlay) return;
            panel.classList.remove('is-open');
            lexOverlay.classList.remove('is-open');
            panel.setAttribute('aria-hidden', 'true');
            lexOverlay.setAttribute('aria-hidden', 'true');
        }

        function renderOverview() {
            if (!dynamicContent) return;
            dynamicContent.style.opacity = '0';
            setTimeout(function () {
                dynamicContent.innerHTML = defaultOverviewHTML;
                dynamicContent.style.opacity = '1';
            }, 150);
        }

        function renderSentenceExplanation(key, sentenceText) {
            if (!dynamicContent) return;
            var explanation = sentenceExplanations[key];
            if (!explanation) {
                renderOverview();
                return;
            }
            dynamicContent.style.opacity = '0';
            setTimeout(function () {
                dynamicContent.innerHTML = '<div class="lexicon-sentence-quote">"' + sentenceText + '"</div><p>' + explanation + '</p>';
                dynamicContent.style.opacity = '1';
            }, 150);
        }

        // Lexicon toggle
        if (lexiconToggle && panel && lexOverlay) {
            lexiconToggle.addEventListener('click', function () {
                if (panel.classList.contains('is-open')) {
                    closePanel();
                } else {
                    if (currentlySelectedSentence && currentlySelectedSentence.dataset.lexiconKey) {
                        renderSentenceExplanation(currentlySelectedSentence.dataset.lexiconKey, currentlySelectedSentence.dataset.sentenceText);
                    } else {
                        renderOverview();
                    }
                    openPanel();
                }
            });

            lexOverlay.addEventListener('click', closePanel);
            
            var closeButtons = panel.querySelectorAll('.lexicon-panel-close');
            closeButtons.forEach(function (btn) {
                btn.addEventListener('click', closePanel);
            });
            
            document.addEventListener('keydown', function (event) {
                if (event.key === 'Escape' && panel.classList.contains('is-open')) {
                    closePanel();
                }
            });
        }

        // Sentence selection
        function clearSentenceSelection() {
            if (currentlySelectedSentence) {
                currentlySelectedSentence.classList.remove('is-selected');
                currentlySelectedSentence = null;
                updateLexiconButtonState();
            }
        }

        function handleSentenceClick(node) {
            if (currentlySelectedSentence === node) {
                clearSentenceSelection();
            } else {
                clearSentenceSelection();
                currentlySelectedSentence = node;
                node.classList.add('is-selected');
                updateLexiconButtonState();
            }
        }

        var sentenceNodes = document.querySelectorAll('.sentence');
        sentenceNodes.forEach(function (node) {
            node.addEventListener('click', function (event) {
                event.stopPropagation();
                handleSentenceClick(node);
            });

            // Touch handling
            var lastTapTime = 0;
            node.addEventListener('touchend', function (event) {
                var currentTime = Date.now();
                var tapLength = currentTime - lastTapTime;
                if (tapLength < 300 && tapLength > 0) {
                    event.preventDefault();
                    event.stopPropagation();
                    handleSentenceClick(node);
                }
                lastTapTime = currentTime;
            });
        });

        // Clear selection on outside click/touch
        function handleOutsideInteraction(event) {
            var isSentence = event.target.closest('.sentence');
            var isLexicon = event.target.closest('#lexiconToggle');
            var isPanel = event.target.closest('#lexiconPanel');
            if (!isSentence && !isLexicon && !isPanel) {
                clearSentenceSelection();
            }
        }

        document.addEventListener('click', handleOutsideInteraction);
        document.addEventListener('touchend', handleOutsideInteraction);

        // Glossary tooltip touch handling with improved mobile UX
        var glossaryTerms = document.querySelectorAll('.glossary-term');
        var currentlyActiveTooltip = null;

        glossaryTerms.forEach(function(term) {
            term.addEventListener('touchstart', function(e) {
                e.preventDefault();

                // If this is already the active tooltip, allow sentence selection to proceed
                if (this === currentlyActiveTooltip) {
                    // Second touch on same glossary term: let it pass through to select the sentence
                    return;
                }

                // First touch: show tooltip and prevent sentence selection
                if (currentlyActiveTooltip) {
                    currentlyActiveTooltip.classList.remove('tooltip-active');
                }
                this.classList.add('tooltip-active');
                currentlyActiveTooltip = this;
            });
        });

        // Hide tooltip when touching elsewhere, and block sentence selection on that touch
        document.addEventListener('touchend', function(e) {
            if (!currentlyActiveTooltip) return;

            var touchedGlossaryTerm = Array.from(glossaryTerms).some(function(term) {
                return term.contains(e.target);
            });

            if (!touchedGlossaryTerm) {
                // Touched outside any glossary term while tooltip is active
                e.preventDefault();
                e.stopImmediatePropagation();
                currentlyActiveTooltip.classList.remove('tooltip-active');
                currentlyActiveTooltip = null;
            }
        }, true); // Use capture phase to intercept early

        // Block sentence selection when deselecting
        document.addEventListener('touchend', function(e) {
            if (!currentlySelectedSentence) return;

            var touchedCurrentSentence = currentlySelectedSentence.contains(e.target);
            var touchedLexicon = e.target.closest('#lexiconToggle');
            var touchedPanel = e.target.closest('#lexiconPanel');

            // If touching outside the selected sentence (and not lexicon/panel), block other selections
            if (!touchedCurrentSentence && !touchedLexicon && !touchedPanel) {
                e.preventDefault();
                e.stopImmediatePropagation();
                clearSentenceSelection();
            }
        }, true); // Use capture phase to intercept early
    })();
    </script>
</body>
</html>