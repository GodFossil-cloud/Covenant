/* Lexicon seal cover rules (ui-stack + iPhone Safari fix).

   ui-stack.js toggles `.is-ui-stack-covered` on #lexiconToggle when Lexicon is open
   but ToC/Reliquary is topmost. [See assets/ui-stack.js]

   Goal:
   - When covered, the seal should *retract back into the dock* (not vanish in-place).

   Why iPhone Safari was instant:
   - In bottom-sheet mode, the seal's position is driven by a transform calc using
     `--seal-drag-y` (set inline by lexicon.js, often as a -100vh/+footer offset expression).
   - Animating `top` won't show.
   - If we push the seal further upward (negative), it can disappear immediately because
     it's already far above its dock seat while Lexicon is open.

   Strategy:
   - Keep using the existing transform pipeline.
   - When covered in the footer, apply a cover offset that *cancels the open lift*
     expression used by lexicon.js, bringing the seal back to its closed seat (~0px).
   - Fade via opacity.
*/

:root{
  --lexicon-cover-fade-ms:220ms;
  --lexicon-cover-ease:cubic-bezier(0.22, 0.61, 0.36, 1);

  /* Viewport unit token used for the cover-cancel math. */
  --lexicon-cover-vh:100vh;

  /* Non-footer fallback motion when covered (desktop/header re-parent case). */
  --lexicon-cover-fallback-y:-22px;
}

@supports (height: 100dvh){
  :root{ --lexicon-cover-vh:100dvh; }
}

/* Base: keep a cover offset var we can animate via transform. */
html body #lexiconToggle{
  opacity:1;
  --lexicon-stack-cover-y:0px;

  will-change:transform, opacity;

  /* IMPORTANT: beat the max-width:600px #lexiconToggle transition in assets/covenant.css. */
  transition:
    color 0.2s ease,
    text-shadow 0.2s ease,
    filter 0.2s ease,

    /* Seal motion channel (drag/snap + cover). */
    transform var(--lexicon-snap-duration, 420ms) var(--lexicon-snap-ease, cubic-bezier(0.22, 0.61, 0.36, 1)),

    /* Cover fade. */
    opacity var(--lexicon-cover-fade-ms) var(--lexicon-cover-ease)
    !important;
}

/* Covered: fade, disable interaction. */
html body #lexiconToggle.is-ui-stack-covered{
  /* Backstop: keep below ui-stack surfaces (Z_BASE=1500). */
  z-index:1490 !important;

  opacity:0 !important;
  pointer-events:none !important;
  filter:none !important;
}

/* Default (non-footer) covered motion: small retract upward.
   We only force a transform when covered to avoid fighting lexicon.js drag math. */
html body #lexiconToggle.is-ui-stack-covered{
  --lexicon-stack-cover-y:var(--lexicon-cover-fallback-y);

  -webkit-transform:translate3d(0, var(--lexicon-stack-cover-y, 0px), 0) !important;
  transform:translate3d(0, var(--lexicon-stack-cover-y, 0px), 0) !important;
}

/* Footer case: preserve the existing drag math from assets/footer-overrides.css and
   add the cover offset into the same translate3d() calc.

   Critical: when Lexicon is open on mobile, lexicon.js sets:
     --seal-drag-y = calc(-100vh + (footer + peek) + seat + 1px)
   So to retract back into the dock we add its inverse:
     cover = calc( 100vh - (footer + peek) - seat - 1px )
   Net â‰ˆ 0px (closed seat), which can visibly animate.
*/
html body #navFooter #lexiconToggle.is-ui-stack-covered{
  --lexicon-stack-cover-y:calc(
    var(--lexicon-cover-vh)
    - (var(--footer-total-height) + var(--lexicon-panel-closed-peek))
    - var(--seal-seat-nudge)
    - 1px
  );

  /* Ensure the transition is defined at the same specificity that owns the transform.
     (Beats any mobile-only transition overrides.) */
  transition:
    transform var(--lexicon-snap-duration, 420ms) var(--lexicon-snap-ease, cubic-bezier(0.22, 0.61, 0.36, 1)),
    opacity var(--lexicon-cover-fade-ms) var(--lexicon-cover-ease)
    !important;

  -webkit-transform:translate3d(
    0,
    calc(0 * var(--seal-rise) + var(--seal-drag-y, 0px) + var(--lexicon-stack-cover-y, 0px) - var(--seal-seat-nudge) + 0px),
    0
  ) !important;

  transform:translate3d(
    0,
    calc(0 * var(--seal-rise) + var(--seal-drag-y, 0px) + var(--lexicon-stack-cover-y, 0px) - var(--seal-seat-nudge) + 0px),
    0
  ) !important;
}

@media (prefers-reduced-motion: reduce){
  html body #lexiconToggle{transition:none !important}

  html body #lexiconToggle.is-ui-stack-covered{
    opacity:0 !important;
    -webkit-transform:translate3d(0, 0, 0) !important;
    transform:translate3d(0, 0, 0) !important;
  }
}
