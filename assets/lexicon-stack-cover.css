/* Lexicon seal cover rules (ui-stack + iPhone Safari fix).

   ui-stack.js toggles `.is-ui-stack-covered` on #lexiconToggle when Lexicon is open
   but ToC/Reliquary is topmost. [See assets/ui-stack.js]

   Goal:
   - When covered, the seal should move away (so it can’t visually cut through the topmost veil).

   iPhone Safari notes:
   - In bottom-sheet mode, the seal position is driven by a transform calc using
     `--seal-drag-y` (set inline by lexicon.js).
   - If we fade to 0 immediately, the motion becomes imperceptible.
     So we intentionally delay opacity slightly on cover so the travel reads.
*/

:root{
  --lexicon-cover-fade-ms:220ms;
  --lexicon-cover-ease:cubic-bezier(0.22, 0.61, 0.36, 1);

  /* Viewport unit token used (only if needed). */
  --lexicon-cover-vh:100vh;

  /* Non-footer fallback motion when covered (desktop/header re-parent case). */
  --lexicon-cover-fallback-y:-22px;

  /* Footer covered motion target: slide just out of the top frame. */
  --lexicon-cover-out-y:calc(-1 * (var(--seal-size, 56px) + 54px));

  /* Let the travel be seen before we fade out. */
  --lexicon-cover-opacity-delay:130ms;
}

@supports (height: 100dvh){
  :root{ --lexicon-cover-vh:100dvh; }
}

/* Base: keep a cover offset var we can animate via transform. */
html body #lexiconToggle{
  opacity:1;
  --lexicon-stack-cover-y:0px;

  will-change:transform, opacity;

  /* IMPORTANT: beat the max-width:600px #lexiconToggle transition in assets/covenant.css. */
  transition:
    color 0.2s ease,
    text-shadow 0.2s ease,
    filter 0.2s ease,

    /* Seal motion channel (drag/snap + cover). */
    transform var(--lexicon-snap-duration, 420ms) var(--lexicon-snap-ease, cubic-bezier(0.22, 0.61, 0.36, 1)),

    /* Cover fade. */
    opacity var(--lexicon-cover-fade-ms) var(--lexicon-cover-ease)
    !important;
}

/* Covered: fade, disable interaction. */
html body #lexiconToggle.is-ui-stack-covered{
  /* Backstop: keep below ui-stack surfaces (Z_BASE=1500). */
  z-index:1490 !important;

  opacity:0 !important;
  pointer-events:none !important;
  filter:none !important;
}

/* Default (non-footer) covered motion: small retract upward.
   We only force a transform when covered to avoid fighting lexicon.js drag math. */
html body #lexiconToggle.is-ui-stack-covered{
  --lexicon-stack-cover-y:var(--lexicon-cover-fallback-y);

  /* Delay opacity on cover so the motion reads before the fade. */
  transition-delay:0ms, var(--lexicon-cover-opacity-delay) !important;

  -webkit-transform:translate3d(0, var(--lexicon-stack-cover-y, 0px), 0) !important;
  transform:translate3d(0, var(--lexicon-stack-cover-y, 0px), 0) !important;
}

/* Footer case (mobile): keep the existing drag math from assets/footer-overrides.css and
   add a *small extra upward offset* so the seal slides just out of the top of the viewport.

   This avoids the prior “retract back into dock” behavior.
*/
html body #navFooter #lexiconToggle.is-ui-stack-covered{
  --lexicon-stack-cover-y:var(--lexicon-cover-out-y);

  /* Ensure the transition is defined at the same specificity that owns the transform.
     (Beats any mobile-only transition overrides.) */
  transition:
    transform var(--lexicon-snap-duration, 420ms) var(--lexicon-snap-ease, cubic-bezier(0.22, 0.61, 0.36, 1)),
    opacity var(--lexicon-cover-fade-ms) var(--lexicon-cover-ease)
    !important;

  /* Let the travel be seen before we fade away. */
  transition-delay:0ms, var(--lexicon-cover-opacity-delay) !important;

  -webkit-transform:translate3d(
    0,
    calc(0 * var(--seal-rise) + var(--seal-drag-y, 0px) + var(--lexicon-stack-cover-y, 0px) - var(--seal-seat-nudge) + 0px),
    0
  ) !important;

  transform:translate3d(
    0,
    calc(0 * var(--seal-rise) + var(--seal-drag-y, 0px) + var(--lexicon-stack-cover-y, 0px) - var(--seal-seat-nudge) + 0px),
    0
  ) !important;
}

@media (prefers-reduced-motion: reduce){
  html body #lexiconToggle{transition:none !important}

  html body #lexiconToggle.is-ui-stack-covered{
    opacity:0 !important;
    -webkit-transform:translate3d(0, 0, 0) !important;
    transform:translate3d(0, 0, 0) !important;
  }
}
